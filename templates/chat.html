{% extends "base.html" %}
{% block content %}
<h2>ü§ñ Gemini AI Chatbot (‡∏ñ‡∏≤‡∏°-‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h2>
<div class="chat">
  <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ -->
  <div id="connection-status" class="row" style="margin-bottom:10px;">
    <div id="status-indicator" class="status-indicator">
      <span id="status-dot" class="status-dot checking"></span>
      <span id="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
    </div>
  </div>
  
  <div id="log" class="log">
    <div class="bubble" style="background:#112834;border-left:4px solid #6ed0ff;">
      <strong>ü§ñ ‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ß‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!</strong><br>
      üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong>9 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2568</strong> (‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä)<br><br>
      
      <strong>ÔøΩ ‡∏â‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:</strong><br><br>
      
      <strong>üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏õ‡∏≤‡∏•‡πå‡∏°:</strong><br>
      ‚Ä¢ "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?"<br>
      ‚Ä¢ "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏≤‡∏•‡πå‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?"<br>
      ‚Ä¢ "‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß"<br><br>
      
      <strong>üåæ ‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:</strong><br>
      ‚Ä¢ "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?"<br>
      ‚Ä¢ "‡∏õ‡∏∏‡πã‡∏¢‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?"<br>
      ‚Ä¢ "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ROI ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏õ‡∏∏‡πã‡∏¢"<br><br>
      
      <strong>üéØ ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏£‡∏≤‡∏¢‡∏ï‡πâ‡∏ô:</strong><br>
      ‚Ä¢ "‡∏ï‡πâ‡∏ô‡∏õ‡∏≤‡∏•‡πå‡∏°‡πÑ‡∏´‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?"<br>
      ‚Ä¢ "‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ó‡∏∞‡∏•‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"<br>
      ‚Ä¢ "‡∏ï‡πâ‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏ß‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏û‡∏¥‡πÄ‡∏®‡∏©?"<br><br>
      
      <strong>üìà ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£:</strong><br>
      ‚Ä¢ "‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"<br>
      ‚Ä¢ "‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?"<br>
      ‚Ä¢ "‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏´‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?"<br><br>
      
      <strong>üóíÔ∏è ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÇ‡∏ô‡πä‡∏ï:</strong><br>
      ‚Ä¢ "‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"<br>
      ‚Ä¢ "‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°?"<br><br>
      
      <small style="color:#888;">üóìÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏±‡∏Å‡∏£‡∏≤‡∏ä (‡∏û.‡∏®.) ‡πÅ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</small>
    </div>
  </div>
  <div class="row">
    <input id="msg" class="input" placeholder="üí¨ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." onkeypress="if(event.key==='Enter')sendMsg()" disabled>
    <button class="btn" onclick="sendMsg()" id="sendBtn" disabled>‡∏™‡πà‡∏á</button>
  </div>
</div>
<script>
// ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
let connectionStatus = 'checking';

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
async function checkConnection() {
  try {
    updateStatus('checking', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
    
    const response = await fetch("{{ url_for('ai.chat_api') }}", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({message: "test"})
    });
    
    const data = await response.json();
    
    if (data.answer && !data.answer.includes("API key not valid") && !data.answer.includes("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤")) {
      updateStatus('connected', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gemini AI ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      enableChat();
    } else {
      updateStatus('error', 'API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤');
      disableChat();
    }
  } catch (error) {
    updateStatus('error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
    disableChat();
  }
}

function updateStatus(status, message) {
  connectionStatus = status;
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  
  dot.className = `status-dot ${status}`;
  text.textContent = message;
}

function enableChat() {
  document.getElementById('msg').disabled = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('msg').focus();
}

function disableChat() {
  document.getElementById('msg').disabled = true;
  document.getElementById('sendBtn').disabled = true;
}

async function sendMsg(){
  const m = document.getElementById('msg').value.trim();
  if(!m || connectionStatus !== 'connected') return;
  
  // Show user message
  addLog("üë§ ‡∏Ñ‡∏∏‡∏ì", m, "#0f1830");
  document.getElementById('msg').value = "";
  
  // Show loading
  const sendBtn = document.getElementById('sendBtn');
  const originalText = sendBtn.textContent;
  sendBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...";
  sendBtn.disabled = true;
  updateStatus('processing', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...');
  
  try {
    const res = await fetch("{{ url_for('ai.chat_api') }}", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({message: m})
    });
    const data = await res.json();
    
    if(data.error){ 
      addLog("‚ùå ‡∏£‡∏∞‡∏ö‡∏ö", data.error, "#341111");
      updateStatus('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      return; 
    }
    
    if(data.sql && data.sql.trim()){
      addLog("üîç SQL Query", data.sql, "#3b2a12");
    }
    
    if(data.rows && data.rows.length){
      addLog("üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏ö", `‡∏û‡∏ö ${data.rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, "#11341e");
      const tbl = renderTable(data.columns, data.rows);
      addHtml(tbl);
    }
    
    if(data.answer){
      addLog("ü§ñ ‡∏™‡∏£‡∏∏‡∏õ", data.answer, "#112834");
    }
    
    updateStatus('connected', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    
  } catch(error) {
    addLog("‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: " + error.message, "#341111");
    updateStatus('error', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á');
  } finally {
    sendBtn.textContent = originalText;
    sendBtn.disabled = false;
  }
}

function addLog(who, text, bgColor = "#0f1830"){
  const div = document.createElement('div');
  div.className = 'bubble';
  div.style.background = bgColor;
  div.innerHTML = `<strong>${who}:</strong><br>${text.replace(/\n/g, '<br>')}`;
  document.getElementById('log').appendChild(div);
  div.scrollIntoView();
}

function addHtml(html){
  const wrap = document.createElement('div');
  wrap.innerHTML = html;
  wrap.style.margin = "10px 0";
  document.getElementById('log').appendChild(wrap);
  wrap.scrollIntoView();
}

function renderTable(cols, rows){
  let html = '<table class="table" style="margin:0;"><thead><tr>';
  cols.forEach(c=> html += `<th>${c}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r=> {
    html += '<tr>';
    r.forEach((v, index) => {
      let display = v;
      
      // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢ (‡∏û.‡∏®.)
      if (cols[index] === 'date' && v && typeof v === 'string' && v.match(/^\d{4}-\d{2}-\d{2}/)) {
        const date = new Date(v);
        const thaiMonths = [
          "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
          "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
        ];
        const thaiYear = date.getFullYear() + 543;
        const thaiMonth = thaiMonths[date.getMonth()];
        display = `${date.getDate()} ${thaiMonth} ${thaiYear}`;
      }
      // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
      else if(typeof v === 'number') {
        display = v.toLocaleString('th-TH', {minimumFractionDigits: 2});
      }
      
      html += `<td>${display || ''}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  return html;
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
window.onload = function() {
  checkConnection();
};
</script>
{% endblock %}
